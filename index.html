<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rezerwacje świetlic gminnych — MVP (HTML print)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .doc h1{font-size:20px;font-weight:700;margin:0 0 8px}
    .doc h2{font-size:14px;color:#555;margin:0 0 10px}
    .doc h3{font-size:12px;font-weight:700;margin:14px 0 6px}
    .doc .signs{display:flex;gap:40px;justify-content:space-between;margin-top:30px}
    .doc table.check{width:100%;border-collapse:collapse;margin-top:8px}
    .doc table.check td,.doc table.check th{border:1px solid #ccc;padding:6px}
    @media print{
      body{background:#fff}
      .no-print{display:none !important}
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="p-4 md:p-6 bg-white shadow">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <h1 class="text-2xl font-bold">Świetlice gminne — rezerwacje</h1>
      <div class="text-sm text-gray-500">MVP — druk dokumentów w HTML</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Lista i filtry -->
    <section class="lg:col-span-1 space-y-3">
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-3">Filtry</h2>
        <div class="space-y-2">
          <input id="q" class="w-full border rounded-xl px-3 py-2" placeholder="Szukaj po nazwie/mieście..."/>
          <label class="block text-sm">Pojemność (min)</label>
          <input id="cap" type="number" min="0" class="w-full border rounded-xl px-3 py-2" placeholder="np. 50"/>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-3">Świetlice (<span id="count">0</span>)</h2>
        <ul id="facilities" class="space-y-3"></ul>
      </div>
    </section>

    <!-- Szczegóły, kalendarz i rezerwacja -->
    <section class="lg:col-span-2 space-y-4">
      <div id="facilityCard" class="hidden bg-white rounded-2xl shadow overflow-hidden">
        <div class="grid grid-cols-1 md:grid-cols-3">
          <img id="facilityImg" class="w-full h-56 object-cover md:col-span-1" alt="Zdjęcie świetlicy"/>
          <div class="p-4 md:col-span-2">
            <h2 id="facilityName" class="text-xl font-bold"></h2>
            <p id="facilityDesc" class="text-sm text-gray-600 mt-1"></p>
            <div class="mt-3 text-sm">
              <div id="facilityAddr" class="text-gray-700"></div>
              <div class="mt-1">
                <span id="facilityCap" class="inline-block bg-gray-100 px-2 py-1 rounded-lg"></span>
                <span id="facilityPrices" class="inline-block bg-gray-100 px-2 py-1 rounded-lg ml-2"></span>
              </div>
              <div id="facilityAmenities" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="calendar" class="hidden bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <button id="prevDay" class="px-3 py-2 rounded-xl border">◀</button>
            <button id="todayBtn" class="px-3 py-2 rounded-xl border">Dziś</button>
            <button id="nextDay" class="px-3 py-2 rounded-xl border">▶</button>
          </div>
          <div class="text-lg font-semibold" id="dateLabel"></div>
        </div>
        <div id="hours" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
        <p class="text-xs text-gray-500 mt-2">Widok dzienny 00–23.</p>
      </div>

      <div id="booking" class="hidden bg-white rounded-2xl shadow p-4">
        <h3 class="font-semibold mb-3">Nowa rezerwacja</h3>
        <form id="bookingForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm">Tytuł wydarzenia</label>
            <input name="title" required class="w-full border rounded-xl px-3 py-2" placeholder="np. Urodziny" />
          </div>
          <div>
            <label class="text-sm">Rodzaj</label>
            <select name="event_type_id" class="w-full border rounded-xl px-3 py-2"></select>
          </div>
          <div>
            <label class="text-sm">Początek</label>
            <input name="start_time" type="datetime-local" required class="w-full border rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="text-sm">Koniec</label>
            <input name="end_time" type="datetime-local" required class="w-full border rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="text-sm">Imię i nazwisko</label>
            <input name="renter_name" required class="w-full border rounded-xl px-3 py-2" />
          </div>
          <div>
            <label class="text-sm">E‑mail</label>
            <input name="renter_email" type="email" required class="w-full border rounded-xl px-3 py-2" />
          </div>
          <div class="md:col-span-2">
            <label class="text-sm">Uwagi (opcjonalnie)</label>
            <textarea name="notes" class="w-full border rounded-xl px-3 py-2" rows="2"></textarea>
          </div>
          <div class="flex items-center gap-2 md:col-span-2">
            <input id="is_public" type="checkbox" checked class="w-4 h-4"/>
            <label for="is_public" class="text-sm">Pokaż tytuł wydarzenia publicznie w kalendarzu</label>
          </div>
          <div class="md:col-span-2 flex gap-2 items-center">
            <button class="px-4 py-2 rounded-xl bg-blue-600 text-white" type="submit">Zarezerwuj</button>
            <a id="genDocsLink" href="#" class="no-print hidden text-blue-700 underline">Generuj dokumenty</a>
            <div id="formMsg" class="text-sm ml-2"></div>
          </div>
        </form>
      </div>

      <div id="templatesList" class="hidden bg-white rounded-2xl shadow p-4">
        <h3 class="font-semibold mb-3">Szablony dokumentów</h3>
        <p class="text-sm text-gray-600 mb-3">Wybierz szablon przypisany do tej świetlicy (jeśli brak — użyte zostaną szablony globalne).</p>
        <ul id="templateItems" class="space-y-2"></ul>
      </div>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto p-6 text-xs text-gray-500">
    MVP: statyczny frontend + Supabase. Druk dokumentów: czysty HTML + window.print().
  </footer>

<script>
// === Konfiguracja Supabase ===
const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co"; // <- PODMIEŃ
const SUPABASE_ANON_KEY = "YOUR-ANON-PUBLIC-KEY";        // <- PODMIEŃ
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

const state = {
  facilities: [],
  amenities: {},
  eventTypes: [],
  selectedFacility: null,
  currentDate: new Date(),
  bookingsCache: new Map(),
  lastBooking: null,
  templates: []
};

function fmtDateLabel(d){ return d.toLocaleDateString('pl-PL', { weekday:'long', year:'numeric', month:'long', day:'numeric' }); }
function ymd(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }

async function loadDictionaries(){
  const [{ data: ams }, { data: evs }] = await Promise.all([
    supabase.from('amenities').select('*').order('name'),
    supabase.from('event_types').select('*').order('name')
  ]);
  (ams||[]).forEach(a=> state.amenities[a.id]=a.name);
  state.eventTypes = evs||[];
  const sel = document.querySelector('select[name="event_type_id"]');
  sel.innerHTML = `<option value="">(brak)</option>` + state.eventTypes.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
}

async function loadFacilities(){
  const { data } = await supabase.from('facilities').select('*').order('name');
  state.facilities = data || [];
  renderFacilityList();
}

function renderFacilityList(){
  const q = $('#q').value.trim().toLowerCase();
  const minCap = parseInt($('#cap').value,10) || 0;
  const list = state.facilities.filter(f=>{
    const hay = `${f.name} ${f.city}`.toLowerCase();
    return hay.includes(q) && (!minCap || (f.capacity||0) >= minCap);
  });
  $('#count').textContent = list.length;
  const ul = $('#facilities');
  ul.innerHTML = list.map(f=>`
    <li>
      <button data-id="${f.id}" class="w-full text-left border rounded-xl p-3 hover:bg-gray-50">
        <div class="font-semibold">${f.name}</div>
        <div class="text-sm text-gray-600">${f.city}${f.capacity?` • do ${f.capacity} osób`:''}</div>
      </button>
    </li>
  `).join('');
  ul.querySelectorAll('button').forEach(btn=> btn.addEventListener('click', ()=> selectFacility(btn.dataset.id)) );
}
$('#q').addEventListener('input', renderFacilityList);
$('#cap').addEventListener('input', renderFacilityList);

async function selectFacility(id){
  const f = state.facilities.find(x=>x.id===id);
  state.selectedFacility = f;
  $('#facilityCard').classList.remove('hidden');
  $('#facilityImg').src = f.image_url || 'https://picsum.photos/800/400';
  $('#facilityName').textContent = f.name;
  $('#facilityDesc').textContent = f.description || '';
  const address = `${f.address_line1||''}${f.address_line2? ', '+f.address_line2:''}, ${f.postal_code||''} ${f.city||''}`;
  $('#facilityAddr').textContent = address;
  $('#facilityCap').textContent = f.capacity? (`Pojemność: ${f.capacity}`) : '';
  $('#facilityPrices').textContent = [
    f.price_per_hour?`Cena/h: ${Number(f.price_per_hour).toFixed(2)} zł`:null,
    f.price_per_day?`Cena/doba: ${Number(f.price_per_day).toFixed(2)} zł`:null,
  ].filter(Boolean).join(' · ');

  // amenity chips
  const { data: joins } = await supabase.from('facility_amenities').select('amenity_id').eq('facility_id', f.id);
  const wrap = $('#facilityAmenities');
  wrap.innerHTML = (joins||[]).map(j=>`<span class="text-xs bg-emerald-50 border border-emerald-200 rounded-lg px-2 py-1">${state.amenities[j.amenity_id]||'—'}</span>`).join('');

  $('#calendar').classList.remove('hidden');
  $('#booking').classList.remove('hidden');
  $('#templatesList').classList.add('hidden');
  state.currentDate = new Date();
  await renderDay();
  await loadTemplatesForFacility();
}

$('#prevDay').addEventListener('click', ()=>{ state.currentDate.setDate(state.currentDate.getDate()-1); renderDay(); });
$('#nextDay').addEventListener('click', ()=>{ state.currentDate.setDate(state.currentDate.getDate()+1); renderDay(); });
$('#todayBtn').addEventListener('click', ()=>{ state.currentDate = new Date(); renderDay(); });

async function fetchBookingsForDay(facilityId, date){
  const key = facilityId+ymd(date);
  if(state.bookingsCache.has(key)) return state.bookingsCache.get(key);
  const start = new Date(date); start.setHours(0,0,0,0);
  const end = new Date(date); end.setHours(23,59,59,999);
  const { data } = await supabase
    .from('public_bookings')
    .select('*')
    .eq('facility_id', facilityId)
    .gte('start_time', start.toISOString())
    .lte('end_time', end.toISOString())
    .order('start_time');
  state.bookingsCache.set(key, data||[]);
  return data||[];
}

async function renderDay(){
  const d = state.currentDate;
  $('#dateLabel').textContent = fmtDateLabel(d);
  const hoursEl = $('#hours');
  hoursEl.innerHTML = '';
  const bookings = await fetchBookingsForDay(state.selectedFacility.id, d);
  const busy = new Array(24).fill(null);
  bookings.forEach(b=>{
    const s = new Date(b.start_time); const e = new Date(b.end_time);
    const dayStart = new Date(d); dayStart.setHours(0,0,0,0);
    const dayEnd = new Date(d); dayEnd.setHours(23,59,59,999);
    const from = Math.max(0, Math.floor((Math.max(s,dayStart)-dayStart)/3600000));
    const to = Math.min(24, Math.ceil((Math.min(e,dayEnd)-dayStart)/3600000));
    for(let h=from; h<to; h++){ busy[h] = b.title || 'Zajęte'; }
  });
  for(let h=0; h<24; h++){
    const label = String(h).padStart(2,'0')+':00';
    const booked = !!busy[h];
    const title = busy[h] || '';
    const cell = document.createElement('div');
    cell.className = `border rounded-xl p-3 ${booked? 'bg-red-50 border-red-200 text-red-800':'bg-white'}`;
    cell.innerHTML = `<div class="font-mono text-sm">${label}</div>` + (booked? `<div class="text-xs">${title}</div>`: `<div class="text-xs text-gray-500">wolne</div>`);
    hoursEl.appendChild(cell);
  }
  // domyślne wartości formularza
  const startInput = document.querySelector('input[name="start_time"]');
  const endInput = document.querySelector('input[name="end_time"]');
  const yyyy = d.getFullYear(); const mm = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
  startInput.value = `${yyyy}-${mm}-${dd}T12:00`;
  endInput.value = `${yyyy}-${mm}-${dd}T14:00`;
}

// Rezerwacja
$('#bookingForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const form = e.currentTarget;
  const formMsg = $('#formMsg');
  formMsg.textContent = 'Trwa zapisywanie...';
  const payload = {
    facility_id: state.selectedFacility.id,
    title: form.title.value.trim(),
    event_type_id: form.event_type_id.value || null,
    start_time: new Date(form.start_time.value).toISOString(),
    end_time: new Date(form.end_time.value).toISOString(),
    renter_name: form.renter_name.value.trim(),
    renter_email: form.renter_email.value.trim(),
    notes: form.notes.value.trim() || null,
    is_public: document.querySelector('#is_public').checked
  };
  if(!payload.title || !payload.start_time || !payload.end_time){ formMsg.textContent = 'Uzupełnij wymagane pola.'; return; }
  if(new Date(payload.end_time) <= new Date(payload.start_time)){ formMsg.textContent = 'Koniec musi być po początku.'; return; }

  const { data, error } = await supabase.from('bookings').insert(payload).select();
  if(error){ console.error(error); formMsg.textContent = 'Błąd: ' + (error.message || 'nie udało się utworzyć rezerwacji.'); return; }
  formMsg.textContent = 'Zarezerwowano!';
  state.lastBooking = data && data[0] ? data[0] : null;
  state.bookingsCache.clear();
  await renderDay();
  // Pokaż link do dokumentów
  $('#genDocsLink').classList.remove('hidden');
});

// Link: generuj dokumenty (lista szablonów)
$('#genDocsLink').addEventListener('click', async (e)=>{
  e.preventDefault();
  if(!state.selectedFacility){ return; }
  await loadTemplatesForFacility();
  $('#templatesList').classList.remove('hidden');
  const top = document.getElementById('templatesList').offsetTop;
  window.scrollTo({ top: top - 20, behavior: 'smooth' });
});

async function loadTemplatesForFacility(){
  const f = state.selectedFacility;
  if(!f){ return; }
  // 1) Szablony przypisane do świetlicy
  const { data: local } = await supabase.from('document_templates').select('*').eq('is_active', true).eq('facility_id', f.id).order('name');
  // 2) Globalne (fallback) jeśli brak lokalnych lub jako uzupełnienie — unikaj duplikatów code
  const { data: global } = await supabase.from('document_templates').select('*').eq('is_active', true).is('facility_id', null).order('name');
  const codes = new Set((local||[]).map(t=>t.code));
  const merged = [...(local||[]), ...(global||[]).filter(t=>!codes.has(t.code))];
  state.templates = merged;

  const ul = $('#templateItems');
  ul.innerHTML = merged.map(t=>`
    <li class="flex items-center justify-between border rounded-xl p-3">
      <div>
        <div class="font-medium">${t.name}</div>
        <div class="text-xs text-gray-500">${t.code}${t.facility_id ? ' • szablon lokalny' : ' • globalny'}</div>
      </div>
      <div class="flex gap-2">
        <button class="px-3 py-2 border rounded-xl" data-action="preview" data-id="${t.id}">Otwórz</button>
        <button class="px-3 py-2 border rounded-xl" data-action="print" data-id="${t.id}">Drukuj</button>
      </div>
    </li>
  `).join('');

  ul.querySelectorAll('button').forEach(btn => btn.addEventListener('click', async (ev)=>{
    const id = ev.currentTarget.dataset.id;
    const act = ev.currentTarget.dataset.action;
    const tpl = merged.find(x=>x.id===id);
    if(!tpl){ return; }
    const html = await renderTemplateHTML(tpl.html);
    if(act==='preview'){ openPreviewWindow(html); }
    if(act==='print'){ openPreviewWindow(html, true); }
  }));
}

// Renderowanie HTML (placeholdery)
function getBookingContext(){
  // Weź ostatnią zapisaną rezerwację jeśli istnieje, w przeciwnym razie z formularza (draft)
  if(state.lastBooking){
    return {
      title: state.lastBooking.title,
      start_time: state.lastBooking.start_time,
      end_time: state.lastBooking.end_time,
      renter_name: state.lastBooking.renter_name,
      renter_email: state.lastBooking.renter_email,
      notes: state.lastBooking.notes || ''
    };
  }
  const form = document.querySelector('#bookingForm');
  return {
    title: form.title.value.trim(),
    start_time: new Date(form.start_time.value).toISOString(),
    end_time: new Date(form.end_time.value).toISOString(),
    renter_name: form.renter_name.value.trim(),
    renter_email: form.renter_email.value.trim(),
    notes: form.notes.value.trim() || ''
  };
}

function getFacilityContext(){
  const f = state.selectedFacility || {};
  const address = `${f.address_line1||''}${f.address_line2? ', '+f.address_line2:''}, ${f.postal_code||''} ${f.city||''}`.trim();
  return {
    name: f.name || '',
    address,
    city: f.city || '',
    postal_code: f.postal_code || '',
    capacity: f.capacity || '',
    price_per_hour: f.price_per_hour || '',
    price_per_day: f.price_per_day || ''
  };
}

function formatDate(iso){ if(!iso) return ''; return new Date(iso).toLocaleDateString('pl-PL'); }
function formatTime(iso){ if(!iso) return ''; return new Date(iso).toLocaleTimeString('pl-PL', {hour:'2-digit', minute:'2-digit'}); }

async function renderTemplateHTML(templateHtml){
  const booking = getBookingContext();
  const facility = getFacilityContext();
  let html = templateHtml;

  // Proste zastąpienia
  const map = {
    '{{booking.title}}': booking.title || '',
    '{{booking.renter_name}}': booking.renter_name || '',
    '{{booking.renter_email}}': booking.renter_email || '',
    '{{booking.notes}}': booking.notes || '',
    '{{facility.name}}': facility.name || '',
    '{{facility.address}}': facility.address || '',
    '{{facility.city}}': facility.city || '',
    '{{facility.postal_code}}': facility.postal_code || '',
    '{{facility.capacity}}': facility.capacity || '',
    '{{facility.price_per_hour}}': facility.price_per_hour || '',
    '{{facility.price_per_day}}': facility.price_per_day || ''
  };
  for(const [k,v] of Object.entries(map)){
    html = html.split(k).join(escapeHtml(String(v)));
  }
  // Filtrowanie dat/czasu
  html = html.replace(/\{\{\s*date\s+booking\.start_time\s*\}\}/g, formatDate(booking.start_time));
  html = html.replace(/\{\{\s*date\s+booking\.end_time\s*\}\}/g, formatDate(booking.end_time));
  html = html.replace(/\{\{\s*time\s+booking\.start_time\s*\}\}/g, formatTime(booking.start_time));
  html = html.replace(/\{\{\s*time\s+booking\.end_time\s*\}\}/g, formatTime(booking.end_time));

  // Dodaj minimalny styl do wydruku
  const style = `
    <style id="print-styles">
      body{font-family:system-ui, sans-serif; padding:24px}
      h1{font-size:20px;margin:0 0 8px 0}
      h2{font-size:14px;margin:0 0 10px 0;color:#666}
      h3{font-size:12px;margin:12px 0 6px 0}
      .doc table{width:100%;border-collapse:collapse}
      .doc table td,.doc table th{border:1px solid #ccc;padding:6px}
      .signs{display:flex;gap:40px;justify-content:space-between;margin-top:30px}
      @page { size: A4; margin: 15mm }
    </style>
  `;
  return `<!doctype html><html><head><meta charset="utf-8" />${style}<title>Dokument</title></head><body>${html}</body></html>`;
}

function openPreviewWindow(html, doPrint=false){
  const w = window.open('', '_blank');
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  if(doPrint){ w.print(); }
}

function escapeHtml(str){
  return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}

// INIT
(async function init(){
  await loadDictionaries();
  await loadFacilities();
})();
</script>
</body>
</html>
